# ä»Šæ—¥å†…å®¹

# 1 ç›®æ ‡å’Œç‰ˆæœ¬

```python
#  ç›®æ ‡ï¼šBç«™è§†é¢‘æ’­æ”¾é‡---ã€‹3æ¬¡è¯¾

#  ç‰ˆæœ¬ï¼šv6.24.0
	adb install appè£…å¥½
```

# 2 æŠ“åŒ…

```python
# 1 Bç«™æ²¡æœ‰åä»£ç†---ã€‹ç›´æ¥æ‰‹æœºé…ç½®ä»£ç†æŠ“åŒ…å³å¯
# 2 æ‰“å¼€Bç«™appï¼Œéšä¾¿ç‚¹å‡»ä¸€ä¸ªè§†é¢‘ï¼ŒæŠ“åŒ…æŸ¥çœ‹
	-å®šä½åˆ°æŸä¸ªå¯ä»¥æé«˜æ’­æ”¾é‡çš„æ¥å£
    -å¤šæ¬¡é‡å¤å‘è¯·æ±‚å°è¯•ï¼ŒæŸ¥çœ‹æ’­æ”¾é‡æ˜¯å¦å¢åŠ 
# 3 æŠ“åŒ…åˆ†æåœ°å€
	-è¯·æ±‚åœ°å€ï¼šhttps://api.bilibili.com/x/report/click/android2
    -è¯·æ±‚æ–¹å¼ï¼šPOST
    -è¯·æ±‚ä½“ï¼šï¼ˆäºŒè¿›åˆ¶å½¢å¼ï¼‰åŠ å¯†çš„
    	ä¸€å †äºŒè¿›åˆ¶
    -è¯·æ±‚å¤´ï¼šï¼ˆéƒ½å¯ä»¥å»æ‰--ã€‹ä½†æ˜¯å’±ä¹ˆè¦ç ´ï¼‰
    	buvid	
    	device-id
    	fp_local
        fp_remote
        session_id
```

![image-20240104200629523](imgs/day17-è¯¾å ‚ç¬”è®°.assets/image-20240104200629523.png)



![image-20240104200814611](imgs/day17-è¯¾å ‚ç¬”è®°.assets/image-20240104200814611.png)

![image-20240104201644969](imgs/day17-è¯¾å ‚ç¬”è®°.assets/image-20240104201644969.png)

# 3 åç¼–è¯‘app

```python
# 1 æ‰“å¼€jadx--ã€‹æŠŠappæ‹–å…¥å³å¯
	-å°±ç‰ˆæœ¬çš„jadxï¼Œé»˜è®¤ä½¿ç”¨å†…å­˜æ¯”è¾ƒå°ï¼ŒBç«™appï¼Œæ¯”è¾ƒå¤§ï¼Œå¯èƒ½åç¼–è¯‘ä¸å‡ºæ¥
    -å’±ä»¬éœ€è¦è°ƒå¤§jadxçš„å†…å­˜
```



## 3.1 jadxè°ƒå¤§å†…å­˜

```python
# 1 å¦‚æœjadxçš„å†…å­˜ä¸è¶³ï¼Œå®¹æ˜“å¯¼è‡´åç¼–è¯‘å¤±è´¥ï¼Œæ‰€ä»¥å’±ä»¬è°ƒå¤§å†…å­˜
1.ä½¿ç”¨è®°äº‹æœ¬æˆ–è€…notpad++æ‰“å¼€jadx-gui.bat
2.æ‰¾åˆ° set DEFAULT_JVM_OPTS="-Xms128M" "-Xmx4g"
3.å°†å…¶ä¿®æ”¹ä¸º set DEFAULT_JVM_OPTS="-Xms128M" "-Xmx16g" åä¿å­˜å°±okäº† (ä½ è¦4g æå‡åˆ°16gæŠŠ-Xmx4gæ”¹æˆ-Xmx16g)
```

![image-20240104202004460](imgs/day17-è¯¾å ‚ç¬”è®°.assets/image-20240104202004460.png)

# 4 è¯·æ±‚ä½“åŠ å¯†ç ´è§£

## 4.1 æœç´¢å®šä½åˆ†æä»£ç 

```python
# 1 åç¼–è¯‘å---ã€‹æœç´¢è¯·æ±‚åœ°å€ï¼š click/android2
# 2 ä¸€ä¸ªä½ç½®ï¼ŒåŒå‡»è¿›å…¥
# 3 æŸ¥æ‰¾ç”¨ä¾‹ï¼šreportClickï¼Œå°±åªæœ‰ä¸€ä¸ªä½ç½®
# 4 ä»£ç å¦‚ä¸‹--ã€‹å˜é‡éƒ½æ˜¯"é­”é¬¼å˜é‡"  a  b  c å•ä¸ªå­—æ¯å˜é‡--ã€‹ä»£ç æ··æ·†äº†--ã€‹éš¾è¯»
# jadxå¯ä»¥ç®€å•åæ··æ·†--ã€‹è¯»èµ·æ¥ç¨å¾®å¥½è¯»ä¸€äº›ï¼Œä½†æ˜¯ï¼Œå½“æˆ‘ä»¬å»hookçš„æ—¶å€™ï¼Œè¿˜æ˜¯ç”¨hookæ··æ·†çš„æ–¹æ³•åï¼Œaï¼Œb

-å’±ä»¬ä¹‹å‰å†™çš„ä»£ç 
String responseString = retrofit.create(HttpReq.class).Login(username, password, sign).execute().body().string();

-åç¼–è¯‘å›æ¥çš„
l<String> execute = retrofit.create(a.class)).reportClick(create).execute();

# 5 æ ¸å¿ƒæ˜¯æŸ¥çœ‹ create ä¼ äº†ä»€ä¹ˆä¸œè¥¿---ã€‹å› ä¸ºå®ƒå°±æ˜¯è¯·æ±‚ä½“
c0 create = c0.create('ç¼–ç æ–¹å¼', d.this.H7(this.b.a(), this.b.b(), this.b.h(), i, j2, this.b.n(), this.b.m(), this.b.k(), this.b.c(), this.b.e(), this.b.l(), this.b.f()));

# 6 çœŸæ­£çš„å†…å®¹ï¼šd.this.H7 æ‰§è¡Œå®Œè¿”å›çš„ç»“æœ
	H7æ–¹æ³•ï¼Œæœ‰å¾ˆå¤šå¾ˆå¤šå‚æ•°
    
# 7 d.this.H7 æºç åˆ†æ

```

![image-20240104202353514](imgs/day17-è¯¾å ‚ç¬”è®°.assets/image-20240104202353514.png)



![image-20240104202454733](imgs/day17-è¯¾å ‚ç¬”è®°.assets/image-20240104202454733.png)

![image-20240104202854615](imgs/day17-è¯¾å ‚ç¬”è®°.assets/image-20240104202854615.png)



![image-20240104204208615](imgs/day17-è¯¾å ‚ç¬”è®°.assets/image-20240104204208615.png)

### 4.1.1 d.this.H7çš„æºç 

```java
public final byte[] H7(long j2, long j4, int i, long j5, long j6, int i2, int i3, long j7, String str, int i4, String str2, String str3) throws Exception {
        long j8;
        int i5;
        Application f2 = BiliContext.f();
        com.bilibili.lib.accounts.b client = com.bilibili.lib.accounts.b.f(f2);
        AccountInfo h = BiliAccountInfo.f.a().h();
        if (h != null) {
            j8 = h.getMid();
            i5 = h.getLevel();
        } else {
            j8 = 0;
            i5 = 0;
        }
    	// 1 æŠŠä¸€å †keyå’Œvalueæ”¾åˆ°äº†treeMap å­—å…¸ä¸­
        TreeMap treeMap = new TreeMap();
        treeMap.put("aid", String.valueOf(j2));
        treeMap.put("cid", String.valueOf(j4));
        treeMap.put("part", String.valueOf(i));
        treeMap.put(EditCustomizeSticker.TAG_MID, String.valueOf(j8));
        treeMap.put("lv", String.valueOf(i5));
        treeMap.put("ftime", String.valueOf(j6));
        treeMap.put("stime", String.valueOf(j5));
        treeMap.put("did", com.bilibili.lib.biliid.utils.f.a.c(f2));
        treeMap.put("type", String.valueOf(i2));
        treeMap.put("sub_type", String.valueOf(i3));
        treeMap.put("sid", String.valueOf(j7));
        treeMap.put("epid", str);
        treeMap.put("auto_play", String.valueOf(i4));
        x.h(client, "client");
        if (client.r()) {
            treeMap.put("access_key", client.g());
        }
        treeMap.put("build", String.valueOf(com.bilibili.api.a.f()));
        treeMap.put("mobi_app", com.bilibili.api.a.l());
        treeMap.put("spmid", str2);
        treeMap.put("from_spmid", str3);
    	// 2 æ„å»ºäº†sbå¯¹è±¡--ã€‹åšå­—ç¬¦ä¸²æ‹¼æ¥
    	// å¾ªç¯mapåšæ‹¼æ¥  aid=23232&cid=999&part=sss&lv=xx
        StringBuilder sb = new StringBuilder();
        for (Map.Entry entry : treeMap.entrySet()) {
            String str4 = (String) entry.getValue();
            sb.append((String) entry.getKey());
            sb.append('=');
            if (str4 == null) {
                str4 = "";
            }
            sb.append(str4);
            sb.append('&');
        }
    	// 3 åˆ é™¤å­—ç¬¦ä¸²æœ€åçš„ & 
    	// sb2=aid=23232&cid=999&part=sss&lv=xx
        sb.deleteCharAt(sb.length() - 1);
        String sb2 = sb.toString();
    	// 4 æ‰§è¡Œ t3.a.i.a.a.a.b.e.b æ–¹æ³•æŠŠsb2å­—ç¬¦ä¸²ä¼ å…¥ï¼ŒåŠ å¯†å¾—åˆ°ç»“æœç»™äº†b2
        String b2 = t3.a.i.a.a.a.b.e.b(sb2);
		// 5 sb=aid=23232&cid=999&part=sss&lv=xx&sign=å‰é¢åŠ å¯†çš„ç»“æœ
    	// å¯¹æ•´ä½“è¿›è¡Œå‰é¢ï¼ŒæŠŠç­¾åæ‹¼åœ¨å­—ç¬¦å
        sb.append("&sign=");
        sb.append(b2);
        String sb3 = sb.toString();
    	// 6 å¯¹æ•´ä¸ªå­—ç¬¦ä¸² ï¼ˆåŒ…å«signï¼‰aid=23232&cid=999&part=sss&lv=xx&sign=å‰é¢åŠ å¯†çš„ç»“æœ
    	// è¿›è¡Œäº†åŠ å¯†--ã€‹æœ€ç»ˆè¿”å›--ã€‹å°±æ˜¯è¯·æ±‚ä½“
        return t3.a.i.a.a.a.b.e.a(sb3);
    }



/*
1 æŠŠä¸€å † key  å’Œ value æ”¾åˆ°äº† TreeMapä¸­
2 æ„å»ºsbå¯¹è±¡ï¼ŒæŠŠtreeMapçš„å†…å®¹ï¼Œæ‹¼æˆå­—ç¬¦ä¸²äº†
     aid=asdfasdf&cid=asadfasd&part=sadfasd&
3 æŠŠå­—ç¬¦ä¸²æœ€å & åˆ é™¤
	sb=aid=asdfasdf&cid=asadfasd&part=sadfasd
4 è°ƒç”¨ï¼š t3.a.i.a.a.a.b.e.bå¯¹ aid=asdfasdf&cid=asadfasd&part=sadfasdè¿›è¡ŒåŠ å¯†ï¼Œå¾—åˆ°å­—ç¬¦ä¸²
5 æŠŠåŠ å¯†åçš„å­—ç¬¦ä¸²æ‹¼æ¥åˆ° aid=asdfasdf&cid=asadfasd&part=sadfasd åé¢
	sb=aid=asdfasdf&cid=asadfasd&part=sadfasd&sign=åŠ å¯†ä¸²
6 è°ƒç”¨t3.a.i.a.a.a.b.e.a(sb3)å¯¹ ä¸Šè¿°å­—ç¬¦ä¸²åŠ å¯†
7 å¾—åˆ°çš„å°±æ˜¯ è¯·æ±‚ä½“çš„å†…
*/
```

### 4.1.2  hook---H7æŸ¥çœ‹

```python
import frida
import sys

rdev = frida.get_remote_device()
session = rdev.attach("å“”å“©å“”å“©")

scr = """
Java.perform(function () {

    var d = Java.use("tv.danmaku.biliplayerimpl.report.heartbeat.d");
    var ByteString = Java.use("com.android.okhttp.okio.ByteString");
    d.H7.implementation = function(j2,  j4,  i2,  j5,  j6,  i3,  i4,  j7,  str,  i5,  str2,  str3){
        console.log("è¯·æ±‚æ¥äº†");
        var res = this.H7(j2,  j4,  i2,  j5,  j6,  i3,  i4,  j7,  str,  i5,  str2,  str3);

        console.log("å­—èŠ‚æ•°ç»„", res);
        console.log("å­—èŠ‚æ•°ç»„", JSON.stringify(res));

        //console.log(ByteString.of(res).hex()); // åœ¨hookæ—¶ï¼Œç›´æ¥æŠŠæŠ“åˆ°çš„å­—ç¬¦æ•°ç»„è½¬æˆ16è¿›åˆ¶
        //console.log(ByteString.of(res).utf8());  //å°†å­—èŠ‚è½¬æ¢æˆå­—ç¬¦ä¸²

        return res;
    };

});
"""

script = session.create_script(scr)
def on_message(message, data):
    print(message, data)


script.on("message", on_message)

script.load()
sys.stdin.read()


'''H7çš„è¿”å›æ•°æ®ï¼Œå°±æ˜¯è¯·æ±‚ä½“å†…å®¹ï¼Œåªä¸è¿‡æ˜¯bytesçš„æ•°ç»„è½¬æˆäº†å­—ç¬¦ä¸²--ã€‹çœ‹ä¸Šå»åƒä¹±ç è€Œå·²
è¯·æ±‚æ¥äº†
å­—èŠ‚æ•°ç»„ 22,59,-39,-77,-51,120,65,45,100,100,-55,63,61,47,63,83,97,41,-103,60,-110,59,-61,76,97,-111,35,108,95,-26,110,69,-76,-25,-82,2,21,-111,-5,45,95,46,-94,74,72,-3,56,-52,-16,4,-114,-65,116,-118,-112,-112,-97,53,73,59,-124,104,-117,-128,-2,105,8,-56,108,-22,-114,112,36,-77,-118,106,-109,6,44,52,-12,-52,-50,-69,117,21,105,5,125,-128,20,104,-44,101,56,-22,-7,105,-55,124,82,-3,-68,-20,64,-72,-48,-70,-38,117,96,7,21,-126,-89,118,-68,101,64,126,29,115,93,-71,55,-5,-27,97,53,-48,7,-93,108,-29,50,23,10,83,27,100,45,54,41,-92,82,52,8,57,18,117,-33,-74,-16,-30,-6,20,-3,8,-52,-46,-106,-48,111,-100,-109,82,109,55,29,2,-89,-111,-99,20,113,24,-90,-55,-77,36,28,-108,-82,-4,9,-118,42,124,100,1,5,-71,106,-32,99,24,-1,-106,-44,-48,-108,58,-88,84,106,43,-106,-58,60,107,50,67,-11,-103,-19,-34,-79,40,-100,48,111,65,-21,65,67,-83,77,-66,-13,20,-88,54,9,-85,-13,-72,90,6,-84,97,44,23,-121,-81,105,8,-67,-25,-120,45,-17,85,-116,-51,64,69,46,87,68,24,-77,49,65,-17,-98,-60,-99,126,43,-74,-113,36,62,36,33,-50,9,-123,49,-6,32,-62,59,109,-61,-69,-115,32,-98,-72,-80,-49,-10,-83,-125,-78,71,45,89,31,-109,114,21,77,-77,-106,0,-115,-94,91,-100,86,-61,78,55,-74,-111,1,92,112,127,22,116,9,-113,31,32,-39,-72,16,78,55,-19,-92,-120,-82
å­—èŠ‚æ•°ç»„ [22,59,-39,-77,-51,120,65,45,100,100,-55,63,61,47,63,83,97,41,-103,60,-110,59,-61,76,97,-111,35,108,95,-26,110,69,-76,-25,-82,2,21,-111,-5,45,95,46,-94,74,72,-3,56,-52,-16,4,-114,-65,116,-118,-112,-112,-97,53,73,59,-124,104,-117,-128,-2,105,8,-56,108,-22,-114,112,36,-77,-118,106,-109,6,44,52,-12,-52,-50,-69,117,21,105,5,125,-128,20,104,-44,101,56,-22,-7,105,-55,124,82,-3,-68,-20,64,-72,-48,-70,-38,117,96,7,21,-126,-89,118,-68,101,64,126,29,115,93,-71,55,-5,-27,97,53,-48,7,-93,108,-29,50,23,10,83,27,100,45,54,41,-92,82,52,8,57,18,117,-33,-74,-16,-30,-6,20,-3,8,-52,-46,-106,-48,111,-100,-109,82,109,55,29,2,-89,-111,-99,20,113,24,-90,-55,-77,36,28,-108,-82,-4,9,-118,42,124,100,1,5,-71,106,-32,99,24,-1,-106,-44,-48,-108,58,-88,84,106,43,-106,-58,60,107,50,67,-11,-103,-19,-34,-79,40,-100,48,111,65,-21,65,67,-83,77,-66,-13,20,-88,54,9,-85,-13,-72,90,6,-84,97,44,23,-121,-81,105,8,-67,-25,-120,45,-17,85,-116,-51,64,69,46,87,68,24,-77,49,65,-17,-98,-60,-99,126,43,-74,-113,36,62,36,33,-50,9,-123,49,-6,32,-62,59,109,-61,-69,-115,32,-98,-72,-80,-49,-10,-83,-125,-78,71,45,89,31,-109,114,21,77,-77,-106,0,-115,-94,91,-100,86,-61,78,55,-74,-111,1,92,112,127,22,116,9,-113,31,32,-39,-72,16,78,55,-19,-92,-120,-82]
163bd9b3cd78412d6464c93f3d2f3f536129993c923bc34c6191236c5fe66e45b4e7ae021591fb2d5f2ea24a48fd38ccf0048ebf748a90909f35493b84688b80fe6908c86cea8e7024b38a6a93062c34f4cccebb751569057d801468d46538eaf969c97c52fdbcec40b8d0bada7560071582a776bc65407e1d735db937fbe56135d007a36ce332170a531b642d3629a4523408391275dfb6f0e2fa14fd08ccd296d06f9c93526d371d02a7919d147118a6c9b3241c94aefc098a2a7c640105b96ae06318ff96d4d0943aa8546a2b96c63c6b3243f599eddeb1289c306f41eb4143ad4dbef314a83609abf3b85a06ac612c1787af6908bde7882def558ccd40452e574418b33141ef9ec49d7e2bb68f243e2421ce098531fa20c23b6dc3bb8d209eb8b0cff6ad83b2472d591f9372154db396008da25b9c56c34e37b691015c707f1674098f1f20d9b8104e37eda488ae
;Ù³ï¿½xA-ddï¿½?=/?Sa)ï¿½<ï¿½;ï¿½Laï¿½#l_ï¿½nEï¿½ï¿½ï¿½ï¿½-_.ï¿½JHï¿½8ï¿½ï¿½ï¿½ï¿½tï¿½ï¿½ï¿½ï¿½5I;ï¿½hï¿½ï¿½ï¿½ï¿½lï¿½p$ï¿½ï¿½jï¿½,4ï¿½ï¿½Î»ui}ï¿½hï¿½e8ï¿½ï¿½iï¿½|Rï¿½ï¿½ï¿½@ï¿½Ğºï¿½u`ï¿½ï¿½vï¿½e@~s]ï¿½7ï¿½ï¿½a5ï¿½ï¿½lï¿½2
Sd-6)ï¿½R9uß¶ï¿½ï¿½ï¿½ï¿½Ò–ï¿½oï¿½ï¿½Rm7ï¿½ï¿½ï¿½qï¿½É³$ï¿½ï¿½ï¿½	ï¿½*|dï¿½jï¿½cï¿½ï¿½ï¿½Ğ”:ï¿½Tj+ï¿½ï¿½<k2Cï¿½ï¿½ï¿½Ş±(ï¿½0oAï¿½ACï¿½Mï¿½ï¿½ï¿½6	ï¿½ï¿½Zï¿½a,ï¿½ï¿½ï¿½ï¿½-ï¿½Uï¿½ï¿½@E.WDï¿½1Aï¿½Ä~+ï¿½ï¿½$>$!ï¿½	ï¿½1ï¿½ ï¿½;mÃ»ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½G-Yï¿½rMï¿½ï¿½

'''
```

![image-20240104205701393](imgs/day17-è¯¾å ‚ç¬”è®°.assets/image-20240104205701393.png)



###  4.1.3 æŠŠhookåˆ°çš„å­—èŠ‚æ•°ç»„--ã€‹è½¬æˆ16è¿›åˆ¶å­—ç¬¦ä¸²

```python
# æŠ“åŒ…æŠ“åˆ°çš„æ˜¯javaçš„ï¼Œæœ‰ç¬¦å·çš„ï¼Œæœ‰è´Ÿæ•°ï¼Œpythonæ²¡æœ‰ï¼Œå…ˆè½¬æˆpythonçš„å­—èŠ‚æ•°ç»„ï¼Œå†è½¬16è¿›åˆ¶


# æŠŠjavaçš„å­—èŠ‚æ•°ç»„ï¼Œè½¬æˆpythonçš„
# v = [æŠ“åŒ…æŠ“åˆ°çš„å­—èŠ‚æ•°ç»„]
v = [22, 59, -39, -77, -51, 120, 65, 45, 100, 100, -55, 63, 61, 47, 63, 83, 97, 41, -103, 60, -110, 59, -61, 76, 97,
     -111, 35, 108, 95, -26, 110, 69, -76, -25, -82, 2, 21, -111, -5, 45, 95, 46, -94, 74, 72, -3, 56, -52, -16, 4,
     -114, -65, 116, -118, -112, -112, -97, 53, 73, 59, -124, 104, -117, -128, -2, 105, 8, -56, 108, -22, -114, 112, 36,
     -77, -118, 106, -109, 6, 44, 52, -12, -52, -50, -69, 117, 21, 105, 5, 125, -128, 20, 104, -44, 101, 56, -22, -7,
     105, -55, 124, 82, -3, -68, -20, 64, -72, -48, -70, -38, 117, 96, 7, 21, -126, -89, 118, -68, 101, 64, 126, 29,
     115, 93, -71, 55, -5, -27, 97, 53, -48, 7, -93, 108, -29, 50, 23, 10, 83, 27, 100, 45, 54, 41, -92, 82, 52, 8, 57,
     18, 117, -33, -74, -16, -30, -6, 20, -3, 8, -52, -46, -106, -48, 111, -100, -109, 82, 109, 55, 29, 2, -89, -111,
     -99, 20, 113, 24, -90, -55, -77, 36, 28, -108, -82, -4, 9, -118, 42, 124, 100, 1, 5, -71, 106, -32, 99, 24, -1,
     -106, -44, -48, -108, 58, -88, 84, 106, 43, -106, -58, 60, 107, 50, 67, -11, -103, -19, -34, -79, 40, -100, 48,
     111, 65, -21, 65, 67, -83, 77, -66, -13, 20, -88, 54, 9, -85, -13, -72, 90, 6, -84, 97, 44, 23, -121, -81, 105, 8,
     -67, -25, -120, 45, -17, 85, -116, -51, 64, 69, 46, 87, 68, 24, -77, 49, 65, -17, -98, -60, -99, 126, 43, -74,
     -113, 36, 62, 36, 33, -50, 9, -123, 49, -6, 32, -62, 59, 109, -61, -69, -115, 32, -98, -72, -80, -49, -10, -83,
     -125, -78, 71, 45, 89, 31, -109, 114, 21, 77, -77, -106, 0, -115, -94, 91, -100, 86, -61, 78, 55, -74, -111, 1, 92,
     112, 127, 22, 116, 9, -113, 31, 32, -39, -72, 16, 78, 55, -19, -92, -120, -82]
l = []
for i in v:
    if i < 0:
        i = i + 256
    l.append(i)
print(l)  # è½¬æˆ16è¿›åˆ¶

###è½¬æˆ16è¿›åˆ¶
res=[hex(item)[2:] for item in l]
print(res)
print(''.join(res)) # è½¬æˆå­—ç¬¦ä¸²ï¼Œè·ŸæŠ“åŒ…ä¸€æ ·


'''
å¯¹æ¯”è¾“å‡ºå‘ç°è·ŸæŠ“åŒ…åˆ°çš„16è¿›åˆ¶å†…å®¹ä¸€è‡´

'''
```

![image-20240104210507953](imgs/day17-è¯¾å ‚ç¬”è®°.assets/image-20240104210507953.png)

## 4.2 signç­¾å

```python
# 1 ä¸Šé¢åˆ†æçš„ï¼š
 è°ƒç”¨ï¼št3.a.i.a.a.a.b.e.bå¯¹ aid=asdfasdf&cid=asadfasd&part=sadfasdè¿›è¡ŒåŠ å¯†ï¼Œå¾—åˆ°ç­¾åå­—ç¬¦ä¸²
# 2 ä»£ç å¦‚ä¸‹--ã€‹ç ´è§£åŠ å¯†å¦‚ä½•åŠ çš„--ã€‹signæ˜¯å¦‚ä½•åŠ å¯†çš„
# sb2    aid=asdfasdf&cid=asadfasd&part=sadfasd
String b2 = t3.a.i.a.a.a.b.e.b(sb2); # åŠ å¯†åæ‹¼æ¥åˆ°äº†å­—ç¬¦ä¸²åé¢
sb.append("&sign=");
sb.append(b2);
# æœ€ç»ˆå˜æˆ aid=asdfasdf&cid=asadfasd&part=sadfasd&sign=ç­¾å

# 3 æŸ¥çœ‹ t3.a.i.a.a.a.b.e.b

```

### 4.2.1  t3.a.i.a.a.a.b.e.b æºç åˆ†æ

```java
// ä¼ å…¥çš„params å°±æ˜¯å¾…åŠ å¯†çš„å­—ç¬¦ä¸²ï¼š aid=asdfasdf&cid=asadfasd&part=sadfasd
public final String b(String params) {
    Charset charset = com.bilibili.commons.c.b;
    // 1 æŠŠä¼ å…¥çš„å­—ç¬¦ä¸²ï¼Œå–åˆ°utf-8çš„ byteæ•°ç»„
    byte[] bytes = params.getBytes("utf-8");
    // 2 dæ˜¯å¸¸é‡ ï¼š9cafa6466a028bfb
    String str = d;
    // 3 charset2 æ˜¯ utf-8
    Charset charset2 = com.bilibili.commons.c.b;
    if (str != null) {
        //4  æŠŠdå¸¸é‡å¯¹åº”çš„å­—ç¬¦ä¸²ï¼š9cafa6466a028bfb ï¼Œä½¿ç”¨utf-8ç¼–ç ï¼Œå¾—åˆ°å­—èŠ‚æ•°ç»„
        byte[] bytes2 = str.getBytes(charset2);
        // 5 æ‰§è¡Œgï¼Œä¼ å…¥äº† ä¸¤ä¸ªå‚æ•°ï¼Œè¿”å›gå­—ç¬¦ä¸²
        // æŠŠæœ€ä¸Šé¢ä¼ å…¥çš„å­—ç¬¦ä¸²ï¼Œå’Œå›ºå®šå€¼keyï¼Œè¿›è¡Œäº†sha256åŠ å¯†
        // g å°±æ˜¯sha256åŠ å¯†ï¼šæ˜æ–‡ï¼šä¼ å…¥çš„å­—ç¬¦ä¸²ï¼Œkeyå°±æ˜¯9cafa6466a028bfb
      
        String g = com.bilibili.commons.m.a.g(bytes, bytes2);
        Locale locale = Locale.US;
        if (g != null) {
            // 6 è½¬æˆå°å†™è¿”å›äº†ï¼ˆæŠŠåŠ å¯†åçš„ä¸²è½¬æˆå°å†™ï¼‰
            String lowerCase = g.toLowerCase(locale);
            return lowerCase;
        }
        throw new TypeCastException("null cannot be cast to non-null type java.lang.String");
    }
    throw new TypeCastException("null cannot be cast to non-null type java.lang.String");
}

```

### 4.2.2 com.bilibili.commons.m.a.g--sha256åŠ å¯†

```java
// ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯æ˜æ–‡ï¼Œä¸€ä¸ªæ˜¯ç›
public static String g(byte[] bArr, byte[] bArr2) {
    try {
        MessageDigest messageDigest = MessageDigest.getInstance(AaidIdConstant.SIGNATURE_SHA256);
        messageDigest.reset();
        messageDigest.update(bArr);
        if (bArr2 != null) {
            messageDigest.update(bArr2);
        }
        // æ˜æ–‡+ç›è¿›è¡Œsha256æ‘˜è¦åï¼Œæ‰§è¡Œäº†g.H
        return g.H(messageDigest.digest());
    } catch (NoSuchAlgorithmException e) {
        throw new AssertionError(e);
    }
}

```

### 4.2.3 g.H(messageDigest.digest());

```java
// æŠŠä¼ å…¥çš„ å­—èŠ‚æ•°ç»„  è½¬æˆ16è¿›åˆ¶--ã€‹è¿”å›å­—ç¬¦ä¸²
public static String H(byte[] bArr) {
    StringBuilder sb = new StringBuilder();
    for (byte b2 : bArr) {
        int i = b2 & 255;
        if (i < 16) {
            sb.append('0');
        }
        sb.append(Integer.toHexString(i));
    }
    return sb.toString();
}

```

### 4.2.4 ç­¾åç”Ÿæˆæ–¹æ¡ˆ

```python
# æŠŠaid=asdfasdf&cid=asadfasd&part=sadfasd é€šè¿‡sha256+ç›---ã€‹æ‘˜è¦---ã€‹è½¬æˆ16è¿›åˆ¶---ã€‹è½¬æˆå°å†™è¿”å›
```

###  4.2.5 é€šè¿‡hook--gç¡®è®¤ç›æ˜¯ä»€ä¹ˆ-æ˜æ–‡æ˜¯ä»€ä¹ˆ

```python
# 9cafa6466a028bfb

import frida
import sys

rdev = frida.get_remote_device()
session = rdev.attach("å“”å“©å“”å“©")

scr = """
Java.perform(function () {
    var a = Java.use("com.bilibili.commons.m.a");
    var ByteString = Java.use("com.android.okhttp.okio.ByteString");
    a.g.implementation = function(bytes, bytes2){
        console.log("è¯·æ±‚æ¥äº†");
        console.log("bytes=",ByteString.of(bytes).utf8());
        console.log("bytes2=",ByteString.of(bytes2).utf8());

        var res = this.g(bytes, bytes2);
        console.log("sign=",res);

        return res;
    };

});
"""

script = session.create_script(scr)


def on_message(message, data):
    print(message, data)


script.on("message", on_message)

script.load()
sys.stdin.read()

'''
1 ä¸€ä¸²å­—ç¬¦ä¸²aid=968620643&auto_play=0&build=6240300&cid=202261238&did=fU52TixILBQlEicfLk93Tw9fNk4rR3UtYQ&epid=329002&from_spmid=tm.recommend.feed.bangumi&ftime=1704374954&lv=0&mid=0&mobi_app=android&part=0&sid=4340&spmid=pgc.pgc-video-detail.0.0&stime=1704374611&sub_type=1&type=4

2 é€šè¿‡ç›ï¼š9cafa6466a028bfb  + sha256 åŠ å¯† å¾—åˆ°åŠ å¯†ä¸²
3 è½¬æˆ16è¿›åˆ¶

'''
```

### 4.2.6 pythonå¤ç°sha-256åŠ å¯†

```python
import hashlib

data = "aid=968620643&auto_play=0&build=6240300&cid=202261238&did=fU52TixILBQlEicfLk93Tw9fNk4rR3UtYQ&epid=329002&from_spmid=tm.recommend.feed.bangumi&ftime=1704374954&lv=0&mid=0&mobi_app=android&part=0&sid=4340&spmid=pgc.pgc-video-detail.0.0&stime=1704374611&sub_type=1&type=4"

salt = "9cafa6466a028bfb"
obj = hashlib.sha256()
obj.update(data.encode('utf-8'))
obj.update(salt.encode('utf-8'))

res = obj.hexdigest()
print(res)

'''
è·Ÿhookåˆ°çš„ä¸€æ ·

'''
```



## 4.3 ç ´è§£è¯·æ±‚ä½“åŠ å¯†

```python
# 1 è¯·æ±‚å¤´åŠ å¯†ï¼št3.a.i.a.a.a.b.e.a(sb3)
aid=968620643&auto_play=0&build=6240300&cid=202261238&did=fU52TixILBQlEicfLk93Tw9fNk4rR3UtYQ&epid=329002&from_spmid=tm.recommend.feed.bangumi&ftime=1704374954&lv=0&mid=0&mobi_app=android&part=0&sid=4340&spmid=pgc.pgc-video-detail.0.0&stime=1704374611&sub_type=1&type=4&sign=4021718af1f29a2279dbcd7d4098a50cc042d8b69e6233c8e517592d598a403d

# 2 æŸ¥çœ‹t3.a.i.a.a.a.b.e.aæºç 

```

### 4.3.1 t3.a.i.a.a.a.b.e.aæºç åˆ†æ

```java
// aid=968620643&auto_play=0&build=6240300&cid=202261238&did=fU52TixILBQlEicfLk93Tw9fNk4rR3UtYQ&epid=329002&from_spmid=tm.recommend.feed.bangumi&ftime=1704374954&lv=0&mid=0&mobi_app=android&part=0&sid=4340&spmid=pgc.pgc-video-detail.0.0&stime=1704374611&sub_type=1&type=4&sign=4021718af1f29a2279dbcd7d4098a50cc042d8b69e6233c8e517592d598a403d


public final byte[] a(String body) {
    try {
        // 1 b æ˜¯ä¸ªå¸¸é‡
        String str = b;
        // 2 charset utf-8 
        Charset charset = com.bilibili.commons.c.b;
        if (str != null) {
            // 3 æŠŠå¸¸é‡è½¬æˆutf-8æ ¼å¼çš„å­—èŠ‚æ•°ç»„
            byte[] bytes = str.getBytes(charset);
            // 4 AES çš„ SecretKey  å¸¸é‡--ã€‹å›ºå®šçš„
            SecretKeySpec secretKeySpec = new SecretKeySpec(bytes, "AES");
            String str2 = f22911c;
            // 5 charset2 utf-8 
            Charset charset2 = com.bilibili.commons.c.b;
            if (str2 != null) {
                // 6 str2 å°±æ˜¯iv
                byte[] bytes2 = str2.getBytes(charset2);
                IvParameterSpec ivParameterSpec = new IvParameterSpec(bytes2);
                Charset charset3 = com.bilibili.commons.c.b;
                byte[] bytes3 = body.getBytes(charset3);
                // 7 æŠŠä¼ å…¥çš„å­—ç¬¦ä¸²,é€šè¿‡aesçš„keyå’ŒivåŠ å¯†
                byte[] i = com.bilibili.droid.g0.a.i(secretKeySpec, ivParameterSpec, bytes3);
                return i;
            }
            throw new TypeCastException("null cannot be cast to non-null type java.lang.String");
        }
        throw new TypeCastException("null cannot be cast to non-null type java.lang.String");
    } catch (Exception e2) {
        BLog.e(a, e2);
        Charset charset4 = com.bilibili.commons.c.b;
        x.h(charset4, "Charsets.UTF_8");
        byte[] bytes4 = body.getBytes(charset4);
        x.h(bytes4, "(this as java.lang.String).getBytes(charset)");
        return bytes4;
    }
}


/*
å‘ç°æ˜¯aesåŠ å¯†
	-æ˜æ–‡æ˜¯ä»€ä¹ˆï¼šçŸ¥é“äº†
	-ivæ˜¯ä»€ä¹ˆï¼šä¸çŸ¥é“   77b07a672d57d64c
	-key æ˜¯ä»€ä¹ˆï¼šä¸çŸ¥é“  fd6b639dbcff0c2a1b03b389ec763c4b
*/
```

### 4.3.2 é€šè¿‡hookå¾—åˆ°aesçš„keyå’Œiv

```python
import frida
import sys

rdev = frida.get_remote_device()
session = rdev.attach("å“”å“©å“”å“©")

scr = """
Java.perform(function () {
    var ByteString = Java.use("com.android.okhttp.okio.ByteString");
    
    var SecretKeySpec = Java.use("javax.crypto.spec.SecretKeySpec");
    SecretKeySpec.$init.overload('[B', 'java.lang.String').implementation = function(key,name){
        console.log("è¯·æ±‚æ¥äº†");
        console.log("key=",ByteString.of(key).utf8());
        console.log("name=",name);
        
        var res = this.$init(key,name);
        return res;
    };
    
    var IvParameterSpec = Java.use("javax.crypto.spec.IvParameterSpec");
    IvParameterSpec.$init.overload('[B').implementation = function(iv){
        console.log("iv=",ByteString.of(iv).utf8());
        var res = this.$init(iv);
        return res;
    };

});
"""

script = session.create_script(scr)


def on_message(message, data):
    print(message, data)


script.on("message", on_message)

script.load()
sys.stdin.read()


'''
æœ€ç»ˆï¼šaesçš„ç§˜é’¥æ˜¯
key= fd6b639dbcff0c2a1b03b389ec763c4b
name= AES
aesçš„ivæ˜¯
iv= 77b07a672d57d64c
'''
```

###  4.3.3 ä½¿ç”¨pythonå®ç°aesåŠ å¯†

```python
from Crypto.Cipher import AES
from Crypto.Util.Padding import pad

KEY = "fd6b639dbcff0c2a1b03b389ec763c4b"
IV = "77b07a672d57d64c"

def aes_encrypt(data_string):
    aes = AES.new(
        key=KEY.encode('utf-8'),
        mode=AES.MODE_CBC,
        iv=IV.encode('utf-8')
    )
    raw = pad(data_string.encode('utf-8'), 16)
    return aes.encrypt(raw)


data = "aid=968620643&auto_play=0&build=6240300&cid=202261238&did=fU52TixILBQlEicfLk93Tw9fNk4rR3UtYQ&epid=329002&from_spmid=tm.recommend.feed.bangumi&ftime=1704374954&lv=0&mid=0&mobi_app=android&part=0&sid=4340&spmid=pgc.pgc-video-detail.0.0&stime=1704374611&sub_type=1&type=4&sign=4021718af1f29a2279dbcd7d4098a50cc042d8b69e6233c8e517592d598a403d"

# å­—èŠ‚ç±»å‹
bytes_data = aes_encrypt(data)

result = [item for item in bytes_data]
print(result)# è¾“å‡ºçš„æ˜¯å­—èŠ‚æ•°ç»„
```



## 4.4 æµç¨‹æ€»ç»“

```python
# 1 æ ¹æ®è¯·æ±‚åœ°å€--ã€‹åç¼–è¯‘æŸ¥æ‰¾ï¼šx/report/click/android2
# 2 æ‰¾åˆ°äº†ä½ç½®ï¼šcom.bilibili.okretro.d.a<String> reportClick(@Body c0 c0Var);
# 3 æŸ¥æ‰¾ç”¨ä¾‹ï¼š
ResponseBody responseBody = retrofit.create(æ¥å£ç±»a.class).reportClick(å‚æ•°).execute().body()
# 4 ç ´è§£å‚æ•°ï¼šc0.create
c0 create = c0.create('ç¼–ç æ–¹å¼', d.this.H7());

# 5 ç ´è§£d.this.H7---ã€‹hookè„šæœ¬--ã€‹ä½ç½®æ˜¯å¯¹çš„
# 6 H7çš„é€»è¾‘
'''
1 æŠŠä¸€å † key  å’Œ value æ”¾åˆ°äº† TreeMapä¸­
2 æ„å»ºsbå¯¹è±¡ï¼ŒæŠŠtreeMapçš„å†…å®¹ï¼Œæ‹¼æˆå­—ç¬¦ä¸²äº†
     aid=asdfasdf&cid=asadfasd&part=sadfasd&
3 æŠŠå­—ç¬¦ä¸²æœ€å & åˆ é™¤
sb=aid=asdfasdf&cid=asadfasd&part=sadfasd
4 è°ƒç”¨ï¼š t3.a.i.a.a.a.b.e.bå¯¹ aid=asdfasdf&cid=asadfasd&part=sadfasdè¿›è¡ŒåŠ å¯†ï¼Œå¾—åˆ°å­—ç¬¦ä¸²
5 æŠŠåŠ å¯†åçš„å­—ç¬¦ä¸²æ‹¼æ¥åˆ° aid=asdfasdf&cid=asadfasd&part=sadfasd åé¢
sb=aid=asdfasdf&cid=asadfasd&part=sadfasd&sign=åŠ å¯†ä¸²
6 è°ƒç”¨t3.a.i.a.a.a.b.e.a(sb3)å¯¹ ä¸Šè¿°å­—ç¬¦ä¸²åŠ å¯†
7 å¾—åˆ°çš„å°±æ˜¯ è¯·æ±‚ä½“çš„å†…å®¹
'''

# 7 ç­¾åçš„æ–¹å¼ signåŠ å¯†ï¼št3.a.i.a.a.a.b.e.b
	sha256+ç›ï¼ˆç›æ˜¯å›ºå®šçš„ï¼‰9cafa6466a028bfb
    
# 8 è¯·æ±‚ä½“åŠ å¯†ï¼št3.a.i.a.a.a.b.e.a
	aesåŠ å¯†
    æ˜æ–‡
    key
    iv
    
```



# 5 è¯·æ±‚å‚æ•°ï¼šaidï¼Œcidï¼Œdid

```python
#1 è¯·æ±‚ä½“å†…å®¹åˆ†æ
aid=968620643&auto_play=0&build=6240300&cid=202261238&did=fU52TixILBQlEicfLk93Tw9fNk4rR3UtYQ&epid=329002&from_spmid=tm.recommend.feed.bangumi&ftime=1704374954&lv=0&mid=0&mobi_app=android&part=0&sid=4340&spmid=pgc.pgc-video-detail.0.0&stime=1704374611&sub_type=1&type=4&sign=4021718af1f29a2279dbcd7d4098a50cc042d8b69e6233c8e517592d598a403d

#2 å˜æˆå­—å…¸
{
    "aid":"968620643",
    "cid":"202261238",
    ---è§†é¢‘å’Œåˆ†çº§id---å”¯ä¸€ç¡®å®šä¸€ä¸ªè§†é¢‘--ç‚¹å‡»æŸä¸ªè§†é¢‘ï¼Œä¼šè¿”å›
    
    ---éœ€è¦ç ´-----
    "did":"fU52TixILBQlEicfLk93Tw9fNk4rR3UtYQ",
    ---è§†é¢‘æ‰“å¼€æ—¶é—´å’Œæ’­æ”¾æ—¶é—´----
    "ftime":"1704374954",
    "stime":"1704374611",
    -----ä¸‹é¢éƒ½å›ºå®š-----
    "auto_play":"0",  # å›ºå®š
    "build":"6240300", # ç‰ˆæœ¬
    "epid":"",    # ç©º 
    "from_spmid":"main.ugc-video-detail.0.0",# å›ºå®š
    "lv":"0", 
    "mid":"0",
    "mobi_app":"android",
    "part":"1",
    "sid":"0",
    "spmid":"main.ugc-video-detail.0.0",
    "sub_type":"0",
    "type":"3"
}

# 3 è¯·æ±‚ä½“ä¸­ï¼š3ä¸ªä¸œè¥¿
	aid
    cid
    did
    éœ€è¦ç ´è§£
```



## 5.1 aidå’Œcidç ´è§£

```python
#1 aidå’Œcidè§†é¢‘å”¯ä¸€idå·---ã€‹åˆ·æŸä¸ªè§†é¢‘çš„æ—¶å€™---ã€‹æˆ‘ä»¬çŸ¥é“è¿™ä¸ªè§†é¢‘idå·çš„
#2 æ‰“å¼€ç½‘é¡µç‰ˆçš„è§†é¢‘åœ°å€ï¼šä¼šè¿”å›è¿™ä¿©å€¼
# é€šè¿‡ç”¨æˆ·æä¾›çš„è§†é¢‘åœ°å€ï¼Œæ‹¿åˆ°aidå’Œcid
```

```python

import requests
import json
import re

header = {
    'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Mobile Safari/537.36'
}
res = requests.get("https://m.bilibili.com/video/BV1eC4y1e73d?spm_id_from=333.337.search-card.all.click&vd_source=57a9cd275f0e009d56b6c9e7e785064f",
                   headers=header)

data_list = re.findall(r'var options = (.+);', res.text)

data_dict = json.loads(data_list[0])
aid = data_dict['aid']
cid = data_dict['cid']
print(aid)
print(cid)
```



## 5.2 didç ´è§£

```python
# 1 æ‰¾åˆ°didä½ç½®ï¼štreeMap.put("did", com.bilibili.lib.biliid.utils.f.a.c(f2));
# 2 çœ‹æºç ï¼Œæ‰¾åˆ°c
public static String c(@Nullable Context context) {
    # 1 åˆ¤æ–­å˜é‡æ˜¯å¦æœ‰å€¼ï¼Œå¦‚æœæœ‰å€¼ï¼Œç›´æ¥è¿”å›äº†ï¼Œæ²¡æœ‰å€¼ï¼Œç»§ç»­å¾€ä¸‹èµ°
    # å…ˆä»å˜é‡çš„å†…å­˜ä¸­å–ï¼Œå¦‚æœå–ä¸åˆ°--ã€‹å»xmlä¸­è¯»--ã€‹å†å–ä¸åˆ°å°±ç”Ÿæˆä¸€ä¸ªï¼Œæ”¾åˆ°xmlä¸­å’Œå˜é‡ä¸­
    if (TextUtils.isEmpty(f13201c)) {
        if (context == null) {
            return "";
        }
        # 2 å»xmlä¸­è¯»
        String f = c2.f.b0.c.a.e.k().f(context);
        f13201c = f;
        if (!TextUtils.isEmpty(f)) {
            return f13201c;
        }
        # 3 å†…å­˜ï¼Œxmlä¸­éƒ½æ²¡æœ‰ï¼Œé€šè¿‡gç”Ÿæˆï¼Œç”Ÿæˆå
        # èµ‹å€¼ç»™äº†å˜é‡ï¼Œæ”¾åœ¨å†…å­˜ä¸­äº†
        f13201c = g(context);
        # æ”¾åœ¨äº†xmlä¸­
        c2.f.b0.c.a.e.k().x(f13201c, context);
        return f13201c;
    }
    return f13201c;
}

# 3 å’±ä»¬ gå¦‚ä½•ç”Ÿæˆçš„
static String g(Context context) {
    # 1 é€šè¿‡è°ƒç”¨fç”Ÿæˆ få­—ç¬¦ä¸²
    String f = f(context);
    #2 å¦‚æœç”Ÿæˆçš„å­—ç¬¦ä¸²é•¿åº¦å°äº4ï¼Œåˆä½¿ç”¨Settings.Secure.getStringæ–¹æ¡ˆç”Ÿæˆ
    if (f.length() < 4) {
        f = Settings.Secure.getString(context.getContentResolver(), "android_id") + "@" + g.g(Build.MODEL);
    }
    # 3 è°ƒç”¨bç”Ÿæˆï¼Œå¹¶è¿”å›
    return b(f);
}

# 4 çœ‹f(context)
# æœ¬è´¨ï¼šmacåœ°å€|è“ç‰™åœ°å€|è®¾å¤‡æ€»çº¿|snå·
public static String f(Context context) {
    StringBuffer stringBuffer = new StringBuffer();
    String j2 = j(context); # wlan.lge.wifimac  macåœ°å€ å¯ä»¥ä¼ªé€ 
    if (j2 != null) {
        String lowerCase = j2.replaceAll("[^0-9A-Fa-f]", "").toLowerCase();
        if (k(lowerCase)) {
            stringBuffer.append(lowerCase);
        }
    }
    stringBuffer.append('|');
    String a2 = z.a("persist.service.bdroid.bdaddr"); # è“ç‰™åœ°å€
    if (a2.length() > 0) {
        String lowerCase2 = a2.replaceAll("[^0-9A-Fa-f]", "").toLowerCase();
        if (k(lowerCase2)) {
            stringBuffer.append(lowerCase2);
        }
    }
    stringBuffer.append('|');
    String h = h(); # è®¾å¤‡æ€»çº¿
    if (h != null) {
        stringBuffer.append(h.toLowerCase());
    }
    stringBuffer.append('|');
    String i = i(); # snå·
    if (i != null) {
        stringBuffer.append(i.toLowerCase());
    }
    return stringBuffer.toString();
}

#5  æŠŠ macåœ°å€|è“ç‰™åœ°å€|è®¾å¤‡æ€»çº¿|snå· æ‹¼æˆå­—ç¬¦ä¸²
# 6 çœ‹båšäº†ä»€ä¹ˆ b(macåœ°å€|è“ç‰™åœ°å€|è®¾å¤‡æ€»çº¿|snå· æ‹¼æˆå­—ç¬¦ä¸²)
# ä½¿ç”¨pythonä¸€æ­¥ä¸€æ­¥å¤ç°--ã€‹ä½¿ç”¨chatgptå®ç°
public static String b(String str) {
    byte[] bytes = str.getBytes();
    bytes[0] = (byte) (bytes[0] ^ ((byte) (bytes.length & 255)));
    for (int i = 1; i < bytes.length; i++) {
        bytes[i] = (byte) ((bytes[i - 1] ^ bytes[i]) & 255);
    }
    try {
        return new String(Base64.encode(bytes, 11));
    } catch (Exception unused) {
        return str;
    }
}

```

###  5.2.1 é€šè¿‡hookå¾—åˆ° did-->ä¸€ä¸ªæ‰‹æœºæ˜¯å›ºå®šçš„--ã€‹æ¢äº†æ‰‹æœºå°±å˜äº†

```python
import frida
import sys

rdev = frida.get_remote_device()
pid = rdev.spawn(["tv.danmaku.bili"]) # å¦‚æœæ˜¯spawnæ–¹æ¡ˆï¼Œå¿…é¡»å†™åŒ…åï¼Œæ”¾åˆ°åˆ—è¡¨ä¸­
session = rdev.attach(pid)


scr = """
Java.perform(function () {
    var didCls = Java.use("com.bilibili.lib.biliid.utils.f.a");

    didCls.f.implementation = function(arg5){
        var res = this.f(arg5);
        console.log("ç”Ÿæˆçš„did = ",res);
        return res;
    }    

});
"""

script = session.create_script(scr)
def on_message(message, data):
    print(message, data)
script.on("message", on_message)
script.load()
rdev.resume(pid)
sys.stdin.read()

'''
hookåˆ°çš„æ˜¯ï¼š|||
'''
```

### 5.2.2 è‡ªå·±ç”Ÿæˆdid

```python
import random
import string


def create_random_mac(sep=":"):
    """ éšæœºç”Ÿæˆmacåœ°å€ """
    data_list = []
    for i in range(1, 7):
        part = "".join(random.sample("0123456789ABCDEF", 2))
        data_list.append(part)
    mac = sep.join(data_list)
	return mac

def gen_sn():
    return "".join(random.sample("123456789" + string.ascii_lowercase, 10))


mac_string = create_random_mac(sep="")
sn = gen_sn()

prev_did = "{}|||{}".format(mac_string, sn)
print(prev_did)
# C775636F793E|||4zlnit6d9q
```



### 5.2.3 ä½è¿ç®—

```java
//bå‡½æ•°--ä½¿ç”¨pythonå®ç°
public static String b(String str) {
    // æŠŠä¼ å…¥çš„å­—ç¬¦ä¸²å˜æˆå­—èŠ‚
    byte[] bytes = str.getBytes();
    //https://zhuanlan.zhihu.com/p/370167569
    // & ä¸è¿ç®—  ^æŒ‰ä½å¼‚æˆ–
    //bytes[0] = bytes[0] ^ (bytes.length & 255);
    bytes[0] = (byte) (bytes[0] ^ ((byte) (bytes.length & 255)));
    for (int i = 1; i < bytes.length; i++) {
        bytes[i] = (byte) ((bytes[i - 1] ^ bytes[i]) & 255);
    }
    try {
        //è½¬æˆbase64è¿”å›
        return new String(Base64.encode(bytes, 11));
    } catch (Exception unused) {
        return str;
    }
}
// python å®ç°
import random
import string
import base64
def base64_encrypt(data_string):
    data_bytes = bytearray(data_string.encode('utf-8'))
    data_bytes[0] = data_bytes[0] ^ (len(data_bytes) & 0xFF)
    for i in range(1, len(data_bytes)):
        data_bytes[i] = (data_bytes[i - 1] ^ data_bytes[i]) & 0xFF
    res = base64.encodebytes(bytes(data_bytes))
    return res.strip().strip(b"==").decode('utf-8')
```



# 6 ä»£ç æ•´åˆ

```python
import random
import string
import base64
import time
import re
import json
import requests
import hashlib

from Crypto.Cipher import AES
from Crypto.Util.Padding import pad


def base64_encrypt(data_string):
    data_bytes = bytearray(data_string.encode('utf-8'))
    data_bytes[0] = data_bytes[0] ^ (len(data_bytes) & 0xFF)
    for i in range(1, len(data_bytes)):
        data_bytes[i] = (data_bytes[i - 1] ^ data_bytes[i]) & 0xFF
    res = base64.encodebytes(bytes(data_bytes))
    return res.strip().strip(b"==").decode('utf-8')


def create_random_mac(sep=":"):
    """ éšæœºç”Ÿæˆmacåœ°å€ """
    data_list = []
    for i in range(1, 7):
        part = "".join(random.sample("0123456789ABCDEF", 2))
        data_list.append(part)
    mac = sep.join(data_list)
    return mac


def gen_sn():
    return "".join(random.sample("123456789" + string.ascii_lowercase, 10))


mac_string = create_random_mac(sep="")

did = base64_encrypt(f"{mac_string}|||")

header = {
    'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Mobile Safari/537.36'
}
res = requests.get("https://www.bilibili.com/video/BV1bg4y1D7aJ/?spm_id_from=333.337.search-card.all.click",
                   headers=header)

data_list = re.findall(r'var options = (.+);', res.text)

data_dict = json.loads(data_list[0])
aid = data_dict['aid']
cid = data_dict['cid']
print('è§†é¢‘aidå’Œcidï¼š%s===%s'%(aid,cid))

# 1.æ˜æ–‡å‚æ•°
data_dict = {
    "aid": aid,
    "auto_play": "0",
    "build": "6240300",
    "cid": cid,
    "did": did,
    "epid": "",
    "from_spmid": "main.ugc-video-detail.0.0",
    "ftime": str(int(time.time() - random.randint(100, 5000))),
    "lv": "0",
    "mid": "0",
    "mobi_app": "android",
    "part": "1",
    "sid": "0",
    "spmid": "main.ugc-video-detail.0.0",
    "stime": str(int(time.time())),
    "sub_type": "0",
    "type": "3"
}

# 2.signç­¾å
v1 = "&".join([f"{key}={data_dict[key]}" for key in sorted(data_dict)])
salt = "9cafa6466a028bfb"
obj = hashlib.sha256()
obj.update(v1.encode('utf-8'))
obj.update(salt.encode('utf-8'))

sign_string = obj.hexdigest()
print(sign_string)

data_string = f"{v1}&sign={sign_string}"

# 3.AESåŠ å¯†

KEY = "fd6b639dbcff0c2a1b03b389ec763c4b"
IV = "77b07a672d57d64c"

aes = AES.new(
    key=KEY.encode('utf-8'),
    mode=AES.MODE_CBC,
    iv=IV.encode('utf-8')
)
bytes_data = pad(data_string.encode('utf-8'), 16)

result = [item for item in bytes_data]
print(result)

```

